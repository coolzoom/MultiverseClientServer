# import clr
# clr.AddReference("System")
# clr.AddReference("Multiverse.Network")

from System.Math import PI
from System.Collections.Generic import *
from Axiom.Core import ColorEx
from Axiom.MathLib import *
from Multiverse.Network import *
from Multiverse.Base import Client
from Multiverse.MathLib import MathUtil
import ClientAPI
import SAPlayer
import SAUtil

def InitStandaloneWorld():
    #ClientAPI.World.IsWorldLocal = True
    # First, the login response
    loginResponse = AuthorizedLoginResponseMessage()
    loginResponse.Oid = 1
    loginResponse.Success = True
    loginResponse.Message = "standalone"
    loginResponse.Version = "standalone"
    MessageDispatcher.Instance.QueueMessage(loginResponse)
    
    # Next, set up the world
    InitializeWorld()

    # Now, set up the player model
    InitializePlayer()

    # Tell the client we're initialized
    SendLoadingStateMessage()

def InitializeWorld():
    
    #terrainInitString = "<Terrain><algorithm>HybridMultifractalWithSeedMap</algorithm><xOffset>-0.4</xOffset><yOffset>-0.3</yOffset><zOffset>0</zOffset><h>0.25</h><lacunarity>2</lacunarity><octaves>8</octaves><metersPerPerlinUnit>800</metersPerPerlinUnit><heightScale>300</heightScale><heightOffset>-0.15</heightOffset><fractalOffset>0.1</fractalOffset><heightFloor>0</heightFloor><seedMapOriginX>-3200</seedMapOriginX><seedMapOriginY>0</seedMapOriginY><seedMapOriginZ>-5120</seedMapOriginZ><seedMapMetersPerSample>128</seedMapMetersPerSample><outsideSeedMapHeight>0</outsideSeedMapHeight><seedMap width=\"50\" height=\"80\" mapFormat=\"digitString\">0000000000000000011111111000000000000000000000000000000000000000011111111111000000000000000000000000000000000000001112212221211000000000000000000000000000000000000112222222222211000000000000000000000000000000000001122222222222211000000000000000000000000000000000112223333222222211000000000000000000000000000000011222333333332222110000000000000000000000000000001122554344443332222110000000000000000000000000000112257655555544333222211000000000000000000000000011225776555555544433221110000000000000000000000000112557766655555444443322110000000000000000000000001125577755665665444443221110000000000000000000000011257987766666664444433322110000000000000000000000112579878866666644444333322110000000000000000000011125798777666666544444333322110000000000000000001121257988766666666665444433321100000000000000000011212579887766666666654444333221100000000000000000112224579877666666666544444333211000000000000000001123445798666666666665544443332110000000000000000011234457986666666666665444433321100000000000000001122444557986666666666654333332211000000000000000112234445579866666666666543332221100000000000000000112334445798666666666665543321110000000000000000001123444555798666666666665433211000000000000000000011233444557986666666666654332211000000000000000000112234444579866666666666544332110000000000000000000112344455787666666666665443322110000000000000000001122344555666666666666665443322110000000000000000001122444557876666666666655533322110000000000000000001124444579866666666666665333322110000000000000000011234445798666666666666653333322110000000000000001122344555798666666666666653333322110111000000000011223445557986666666666666533333321101210000000000011224445579866666666666665533333221111100000000000011234445798666666666666665333333221100000000000000112234457986666666666666653333333211000000000000000112244557986666666666666533333332110000000000000000112345579866666666666665333333321100000000000000011223445579866666666666444433333211000000000000000112444557688666666666644443333332110000000000000001122445576877666666664444333333322110000000000000001124445678776666666644444433333211000000000000000011234456798766644444444433333222110000000000000000112344579997764444444444333332121100000000000000001123455799976444444444444433321110000200000000000011244568999764444444444444333221100000000000000000112445677786555554444466444333211100000000000000011224444556655555544446666443332221100000000000000112334444445555655555666664443322110000000000000001123344444445555655576666644332211000000000000000111233344444455555555577776553221100000000000000111222333444444445555555577766532110000000000000011122333334444444575555555577665221100000000000001122223333344444445755555555576652110000000000000011222333333444444557555555555566421100000000000000112223333344444445766555555555642211000000000000001122233334444444457655555554455421100000000000000011222333334444445586443334444542211000000000000000011222333334444575754333344442211100000000000000001122222333344445755433333442221110000000000000000001122223333334557544333333221110000000000000000000001122223333345675433333222111000000000000000000000001111222333557533333332111000000000000000000000000001111122222553333333222110000000000000000000000000000011111122533333332121100000000000000000000000000000001111122333333321110000000000000000000000000000000000001123333332211100000000000000000000000000000000000011233333321100000000000000000000000000000000000000112233333211000000000000000000000000000000000000000112233332110000000000000000000000000000000000000000112233321100000000000000000000000000000000000000000112233221100000000000000000000000000000000000000000112223211000000000000000000000000000000000000000000111232110000000000000000000000000000000000000000000112221100000000000000000000000000000000000000000000111221100000000000000000000000000000000000000000000111110000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</seedMap></Terrain>"
    
    # Initialization messages
    terrainConfigMessage = TerrainConfigMessage()
    terrainString = SAUtil.GetTerrainString()
    terrainConfigMessage.ConfigString = terrainString
    MessageDispatcher.Instance.QueueMessage(terrainConfigMessage)

    newObjMessage = NewObjectMessage()
    newObjMessage.Oid = 1
    newObjMessage.ObjectId = 1
    newObjMessage.Name = SAPlayer.Name
    spawnLoc = SAUtil.GetWorldMarker(SAPlayer.SpawnMarkerName)
    # by the beach
    newObjMessage.Location = spawnLoc[0]
    newObjMessage.Orientation = spawnLoc[1]
    newObjMessage.ScaleFactor = Vector3.UnitScale
    newObjMessage.ObjectType = ObjectNodeType.User
    newObjMessage.FollowTerrain = False
    MessageDispatcher.Instance.QueueMessage(newObjMessage)

    uiThemeMessage = UiThemeMessage()
    uiThemeMessage.UiModules = List[str]()
    uiThemeMessage.UiModules.Add("basic.toc")
    # uiThemeMessage.UiModules.Add("mars.toc")
    MessageDispatcher.Instance.QueueMessage(uiThemeMessage)

    # End of initialization messages


def InitializePlayer():
    modelInfoMessage = OldModelInfoMessage()
    modelInfoMessage.Oid = 1
    meshInfo = MeshInfo()

    meshInfo.MeshFile = SAPlayer.Mesh

    modelInfoMessage.ModelInfo.Add(meshInfo)
    MessageDispatcher.Instance.QueueMessage(modelInfoMessage)

def SendLoadingStateMessage():
    loadingStateMessage = LoadingStateMessage()
    loadingStateMessage.LoadingState = False
    MessageDispatcher.Instance.QueueMessage(loadingStateMessage)
    
def PlayerInitHandler(sender, args):
    SAUtil.SetupPlayer()
    
ClientAPI.Log("running Standalone.py")    
ClientAPI.RegisterEventHandler('PlayerInitialized', PlayerInitHandler)
InitStandaloneWorld()
ClientAPI.Log("done running Standalone.py")
